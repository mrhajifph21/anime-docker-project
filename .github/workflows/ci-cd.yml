name: CI/CD Auto Pull and Rebuild
# halo aku jay
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-jay:
    runs-on: [jay]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'anime-recommendation' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå Folder anime-recommendation tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "üìÅ Project path: $PROJECT_PATH"
    
    - name: Fix local repo by fresh clone
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        cd ${{ env.PROJECT_PATH }}
        rm -rf .git
        git init
        git remote add origin https://github.com/mrhajifph21/anime-docker-project.git
        git fetch origin main
        git checkout -f main
      

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin main
        git reset --hard origin/main

    - name: Stop existing containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: docker compose down || true

    - name: Remove old images
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker system prune -f
        docker image prune -a -f

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose build --no-cache
        docker compose up -d

    - name: Wait for services to be ready
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        sleep 30
        docker compose ps

    - name: Health check
      run: curl -f http://localhost:80 || exit 1
